---
title: "Fraktionierung auf Autorenebene"
author: "Stephan Stahlschmidt"
date: "24 Februar 2017"
output: github_document
bibliography: MeineBibliothek.bib
csl: emerald-harvard.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
# setting up Oracle connection to local DB
library("ROracle")
library("knitr")
OraInit <- Oracle()
# connect.string <- paste0("(DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=srv10-oracle)(PORT=1521))(CONNECT_DATA=(SID=ifqdata)))")
connect.string <- "(DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=127.0.0.1)(PORT=6025))(CONNECT_DATA=(SID=bibliodb01)))"
source("credentials_local.R")
source("credentials.R")
OraConn <- dbConnect(OraInit, username=sql_uid, password=sql_pw, dbname = connect.string)
```

# Sachverhalt

@waltman_field-normalized_2015 zeigen auf das full counting nicht kompatibel mit Feld-Normalisierung ist. Sie schlagen vor eine fractional counting auf Ebene der Autoren durchzuführen.

Hierbei entstehen zwei Schwierigkeiten:

1. Verschiedene Autoren eines papers können der gleichen Institution angehören
2. Autoren können gleichzeitig verschiedenen Institutionen angehören

Beispiel:
```{sql connection=OraConn}
SELECT fk_items, fk_authors, fk_institutions, type, pubyear, DOI
FROM wos12b.items it
JOIN wos12b.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
WHERE fk_items = 1052207263
```

Lösung: Basierend auf gut gepflegeten Daten kann die Fraktionierung auf Autorenebene und nachgelagerte Zuschreibung auf Institutionen wie folgt berechnet werden.
```{sql connection=OraConn}
SELECT DISTINCT fk_items, fk_institutions,
  SUM(inst_share) OVER (PARTITION BY fk_items, fk_institutions) AS inst_sum
FROM(
  SELECT fk_items, fk_institutions,
    (1/author_cnt)/(COUNT (fk_institutions) OVER (PARTITION BY fk_items, fk_authors)) AS inst_share
  FROM wos12b.items it
  JOIN wos12b.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
  WHERE fk_items = 1052207263
    AND type = 'RS'
  )
```

Die Biliometriedatenbanken von WoS und Scopus unterscheiden sich in der Nutzung von *fk_authors* und *type*. WoS führt die selbe *fk_authors* ID einmal als *RP* und einmal als *RS*, während in Scopus für den corresponding author zwei verschiedene *fk_authors* IDs vergeben werden, die sich in ihrem *type* (*RS* vs *RP*) unterscheiden. In beiden Datanbanken müssen corresponding authors mit dem *type RP* von der Fraktionierung ausgeschlossen werden.

# Probleme
Die für die Fraktionierung benötigten Felder *fk_authors*, *type* und *fk_institutions* sind nicht immer gut gepflegt.

*Article* und *Review* pro Jahr:
```{sql connection = OraConn, output.var = "papersByYear", eval = FALSE}
SELECT pubyear, COUNT(DISTINCT fk_items)
FROM wos12b.items it
JOIN wos12b.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
WHERE datasource = 'WOSCI'
  AND pubtype = 'J'
  AND doctype IN ('@ Article', 'R Review')
  AND pubyear BETWEEN 2005 AND 2014
  AND type = 'RS'
GROUP BY pubyear
ORDER BY pubyear ASC
```
```{r echo = FALSE}
papersByYear <- dbGetQuery(OraConn, strwrap(paste0("
  SELECT pubyear, COUNT(DISTINCT fk_items)
  FROM wos12b.items it
  JOIN wos12b.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
  WHERE datasource = 'WOSCI'
    AND pubtype = 'J'
    AND doctype IN ('@ Article', 'R Review')
    AND pubyear BETWEEN 2005 AND 2014
    AND type = 'RS'
  GROUP BY pubyear
  ORDER BY pubyear ASC
  "),
  width = 100000, simplify = TRUE)
  )
```


*Article* und *Review* mit *fk_authors* als NULL:
```{sql connection = OraConn, output.var = "paperNullAuthor", eval=FALSE}
SELECT pubyear, COUNT(DISTINCT fk_items)
FROM wos12b.items it
JOIN wos12b.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
WHERE fk_authors IS NULL
  AND datasource = 'WOSCI'
  AND pubtype = 'J'
  AND doctype IN ('@ Article', 'R Review')
  AND pubyear BETWEEN 2005 AND 2014
  AND type = 'RS'
GROUP BY pubyear
ORDER BY pubyear ASC
```
```{r echo=FALSE}
paperNullAuthor <- dbGetQuery(OraConn, strwrap(paste0("
  SELECT pubyear, COUNT(DISTINCT fk_items)
  FROM wos12b.items it
  JOIN wos12b.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
  WHERE fk_authors IS NULL
    AND datasource = 'WOSCI'
    AND pubtype = 'J'
    AND doctype IN ('@ Article', 'R Review')
    AND pubyear BETWEEN 2005 AND 2014
    AND type = 'RS'
  GROUP BY pubyear
  ORDER BY pubyear ASC
  "),
  width = 100000, simplify = TRUE)
  )
```

*Article* und *Review* mit *fk_institutions* als NULL:
```{sql connection = OraConn, output.var = "paperNullInstitution", eval = FALSE}
SELECT pubyear, COUNT(DISTINCT fk_items)
FROM wos12b.items it
JOIN wos12b.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
WHERE fk_institutions IS NULL
  AND datasource = 'WOSCI'
  AND pubtype = 'J'
  AND doctype IN ('@ Article', 'R Review')
  AND pubyear BETWEEN 2005 AND 2014
  AND type = 'RS'
GROUP BY pubyear
ORDER BY pubyear ASC
```
```{r echo = FALSE}
paperNullInstitution <- dbGetQuery(OraConn, strwrap(paste0("
  SELECT pubyear, COUNT(DISTINCT fk_items)
  FROM wos12b.items it
  JOIN wos12b.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
  WHERE fk_institutions IS NULL
    AND datasource = 'WOSCI'
    AND pubtype = 'J'
    AND doctype IN ('@ Article', 'R Review')
    AND pubyear BETWEEN 2005 AND 2014
  GROUP BY pubyear
  ORDER BY pubyear ASC
  "),
  width = 100000, simplify = TRUE)
  )
```
```{r tab_friction, echo = FALSE}
tab_friction <- as.matrix(cbind(paperNullAuthor[,2]/papersByYear[,2], paperNullInstitution[,2]/papersByYear[,2]))*100
colnames(tab_friction) <- c("fk_authors","fk_institutions")
rownames(tab_friction) <- as.character(2005:2014)
kable(tab_friction, digits = 1, caption = "Prozentualer Anteil von pk_items mit NULL im fk_authors oder fk_institutions, i.e. fehlende Zuordnung zwischen author und institution")
```

Differenz zwischen *author_cnt* und Zählung der *fk_authors*:

```{sql connection=OraConn, output.var = "dif_author_counting", eval = FALSE}
SELECT pubyear, SUM(diff)
FROM(
  SELECT DISTINCT fk_items, pubyear,
    CASE  WHEN author_cnt = (COUNT(DISTINCT fk_authors) OVER (PARTITION BY fk_items))
            THEN 0
          ELSE 1
    END diff
  FROM wos12b.items it
  JOIN wos12b.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
  WHERE datasource = 'WOSCI'
    AND pubtype = 'J'
    AND doctype IN ('@ Article', 'R Review')
    AND pubyear BETWEEN 2005 AND 2014
    AND type = 'RS'
)
GROUP BY pubyear
ORDER BY pubyear ASC
```
```{r tab_dif_author_counting, echo = FALSE}
dif_author_counting <- dbGetQuery(OraConn, strwrap(paste0("
  SELECT pubyear, SUM(diff)
  FROM(
    SELECT DISTINCT fk_items, pubyear,
      CASE  WHEN author_cnt = (COUNT(DISTINCT fk_authors) OVER (PARTITION BY fk_items))
              THEN 0
            ELSE 1
      END diff
    FROM wos12b.items it
    JOIN wos12b.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
    WHERE datasource = 'WOSCI'
      AND pubtype = 'J'
      AND doctype IN ('@ Article', 'R Review')
      AND pubyear BETWEEN 2005 AND 2014
      AND type = 'RS'
  )
  GROUP BY pubyear
  ORDER BY pubyear ASC
  "),
  width = 100000, simplify = TRUE)
  )
```

Differenz zwischen *inst_cnt* und Zählung der *fk_institutions*:

```{sql connection=OraConn, output.var = "dif_institutions_counting", eval = FALSE}
SELECT pubyear, SUM(diff)
FROM(
  SELECT DISTINCT fk_items, pubyear,
    CASE  WHEN inst_cnt = (COUNT(DISTINCT fk_institutions) OVER (PARTITION BY fk_items))
            THEN 0
          ELSE 1
    END diff
  FROM wos12b.items it
  JOIN wos12b.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
  WHERE datasource = 'WOSCI'
    AND pubtype = 'J'
    AND doctype IN ('@ Article', 'R Review')
    AND pubyear BETWEEN 2005 AND 2014
    AND type = 'RS'
)
GROUP BY pubyear
ORDER BY pubyear ASC
```
```{r tab_dif_institutions_counting, echo = FALSE}
dif_institutions_counting <- dbGetQuery(OraConn, strwrap(paste0("
  SELECT pubyear, SUM(diff)
  FROM(
    SELECT DISTINCT fk_items, pubyear,
      CASE  WHEN inst_cnt = (COUNT(DISTINCT fk_institutions) OVER (PARTITION BY fk_items))
              THEN 0
            ELSE 1
      END diff
    FROM wos12b.items it
    JOIN wos12b.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
    WHERE datasource = 'WOSCI'
      AND pubtype = 'J'
      AND doctype IN ('@ Article', 'R Review')
      AND pubyear BETWEEN 2005 AND 2014
      AND type = 'RS'
  )
  GROUP BY pubyear
  ORDER BY pubyear ASC
  "),
  width = 100000, simplify = TRUE)
  )
tmp <- as.matrix(dif_institutions_counting[,2]/papersByYear[,2] * 100)
tmp2 <- as.matrix(dif_author_counting[,2]/papersByYear[,2] * 100)
tmp <- cbind(tmp2,tmp)
rownames(tmp) <- as.character(2005:2014)
kable(tmp, digits = 1, caption = "Prozentualer Anteil von pk_items mit Unterschieden in author_cnt, bzw. inst_cnt und Zählung der zugehörigen fk_authors, bzw. fk_institutions", row.names = TRUE, col.names=c("fk_authors", "fk_institutions"))
```

Die mangelnde Übereinstimmung zwischen *author_cnt* und der Zählung *COUNT (DISTINCT fk_authors)* wird durch die vielen NULL in *type* verursacht.

Die ansteigende Differenz zwischen *inst_cnt* und der Zählung *COUNT(DISTINCT fk_institutions)* erklärt sich aus der Tatsache, dass für verschieden Untereinheiten einer Universität verschieden *fk_institutions* vergeben werden, während *inst_cnt* nur die aggregierte Einheit, sprich die Universität als ganzes, zählt.

# Scopus

Die Datenqualität von Scopus erscheint signifikant besser zu sein, und zwar für den aktuellen Rand als auch insbesondere für vergangene Jahre.

*Article* und *Review* pro Jahr:
```{sql connection = OraConn, output.var = "papersByYear_sc", eval = FALSE}
SELECT pubyear, COUNT(DISTINCT fk_items)
FROM scopus_b_2016.items it
JOIN scopus_b_2016.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
WHERE pubtype = 'J'
  AND doctype IN ('ar', 're')
  AND pubyear BETWEEN 1996 AND 2014
  AND type = 'RS'
GROUP BY pubyear
ORDER BY pubyear ASC
```
```{r echo=FALSE}
papersByYear_sc <- dbGetQuery(OraConn, strwrap(paste0("
  SELECT pubyear, COUNT(DISTINCT fk_items)
  FROM scopus_b_2016.items it
  JOIN scopus_b_2016.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
  WHERE pubtype = 'J'
  AND doctype IN ('ar', 're')
    AND pubyear BETWEEN 1996 AND 2014
    AND type = 'RS'
  GROUP BY pubyear
  ORDER BY pubyear ASC
  "),
  width = 100000, simplify = TRUE)
  )
```

*Article* und *Review* mit *fk_authors* als NULL:
```{sql connection = OraConn, output.var = "paperNullAuthor_sc", eval = FALSE}
SELECT pubyear, COUNT(DISTINCT fk_items)
FROM scopus_b_2016.items it
JOIN scopus_b_2016.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
WHERE fk_authors IS NULL
  AND pubtype = 'J'
  AND doctype IN ('ar', 're')
  AND pubyear BETWEEN 1996 AND 2014
  AND type = 'RS'
GROUP BY pubyear
ORDER BY pubyear ASC
```
```{r echo = FALSE}
paperNullAuthor_sc <- dbGetQuery(OraConn, strwrap(paste0("
  SELECT pubyear, COUNT(DISTINCT fk_items)
  FROM scopus_b_2016.items it
  JOIN scopus_b_2016.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
  WHERE fk_authors IS NULL
    AND pubtype = 'J'
    AND doctype IN ('ar', 're')
    AND pubyear BETWEEN 1996 AND 2014
    AND type = 'RS'
  GROUP BY pubyear
  ORDER BY pubyear ASC
  "),
  width = 100000, simplify = TRUE)
  )
```

*Article* und *Review* mit *fk_institutions* als NULL:
```{sql connection = OraConn, output.var = "paperNullInstitution_sc", eval = FALSE}
SELECT pubyear, COUNT(DISTINCT fk_items)
FROM scopus_b_2016.items it
JOIN scopus_b_2016.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
WHERE fk_institutions IS NULL
  AND pubtype = 'J'
  AND doctype IN ('ar', 're')
  AND pubyear BETWEEN 1996 AND 2014
  AND type = 'RS'
GROUP BY pubyear
ORDER BY pubyear ASC
```
```{r echo = FALSE}
paperNullInstitution_sc <- dbGetQuery(OraConn, strwrap(paste0("
  SELECT pubyear, COUNT(DISTINCT fk_items)
  FROM scopus_b_2016.items it
  JOIN scopus_b_2016.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
  WHERE fk_institutions IS NULL
    AND pubtype = 'J'
    AND doctype IN ('ar', 're')
    AND pubyear BETWEEN 1996 AND 2014
    AND type = 'RS'
  GROUP BY pubyear
  ORDER BY pubyear ASC
  "),
  width = 100000, simplify = TRUE)
  )
```
```{r tab_friction_sc, echo = FALSE}
tab_friction_sc <- as.matrix(cbind(paperNullAuthor_sc[,2]/papersByYear_sc[,2],
                                   paperNullInstitution_sc[,2]/papersByYear_sc[,2]))*100
colnames(tab_friction_sc) <- c("fk_authors","fk_institutions")
rownames(tab_friction_sc) <- as.character(1996:2014)
kable(tab_friction_sc, digits = 1, caption = "Prozentualer Anteil von pk_items mit NULL im fk_authors oder fk_institutions (Scopus)")
```

Differenz zwischen *author_cnt* und Zählung der *fk_authors*:

```{sql connection=OraConn, output.var = "dif_author_counting", eval = FALSE}
SELECT pubyear, SUM(diff)
FROM(
  SELECT DISTINCT fk_items, pubyear,
    CASE  WHEN author_cnt = (COUNT(DISTINCT fk_authors) OVER (PARTITION BY fk_items))
            THEN 0
          ELSE 1
    END diff
  FROM scopus_b_2016.items it
  JOIN scopus_b_2016.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
  WHERE pubtype = 'J'
    AND doctype IN ('ar', 're')
    AND pubyear BETWEEN 1996 AND 2014
    AND type = 'RS'
)
GROUP BY pubyear
ORDER BY pubyear ASC
```
```{r tab_dif_author_counting_sc, echo = FALSE}
dif_author_counting_sc <- dbGetQuery(OraConn, strwrap(paste0("
  SELECT pubyear, SUM(diff)
  FROM(
    SELECT DISTINCT fk_items, pubyear,
      CASE  WHEN author_cnt = (COUNT(DISTINCT fk_authors) OVER (PARTITION BY fk_items))
              THEN 0
            ELSE 1
      END diff
    FROM scopus_b_2016.items it
    JOIN scopus_b_2016.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
    WHERE pubtype = 'J'
    AND doctype IN ('ar', 're')
    AND pubyear BETWEEN 1996 AND 2014
    AND type = 'RS'
  )
  GROUP BY pubyear
  ORDER BY pubyear ASC
  "),
  width = 100000, simplify = TRUE)
  )
```

Differenz zwischen *inst_cnt* und Zählung der *fk_institutions*:

```{sql connection=OraConn, output.var = "dif_institutions_counting", eval = FALSE}
SELECT pubyear, SUM(diff)
FROM(
  SELECT DISTINCT fk_items, pubyear,
    CASE  WHEN inst_cnt = (COUNT(DISTINCT fk_institutions) OVER (PARTITION BY fk_items))
            THEN 0
          ELSE 1
    END diff
  FROM scopus_b_2016.items it
  JOIN scopus_b_2016.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
  WHERE pubtype = 'J'
    AND doctype IN ('ar', 're')
    AND pubyear BETWEEN 1996 AND 2014
    AND type = 'RS'
)
GROUP BY pubyear
ORDER BY pubyear ASC
```
```{r tab_dif_institutions_counting_sc, echo = FALSE}
dif_institutions_counting_sc <- dbGetQuery(OraConn, strwrap(paste0("
  SELECT pubyear, SUM(diff)
  FROM(
    SELECT DISTINCT fk_items, pubyear,
      CASE  WHEN inst_cnt = (COUNT(DISTINCT fk_institutions) OVER (PARTITION BY fk_items))
              THEN 0
            ELSE 1
      END diff
    FROM scopus_b_2016.items it
    JOIN scopus_b_2016.ITEMS_AUTHORS_INSTITUTIONS iai ON it.pk_items = iai.fk_items
    WHERE pubtype = 'J'
    AND doctype IN ('ar', 're')
    AND pubyear BETWEEN 1996 AND 2014
    AND type = 'RS'
  )
  GROUP BY pubyear
  ORDER BY pubyear ASC
  "),
  width = 100000, simplify = TRUE)
  )
tmp <- as.matrix(dif_institutions_counting_sc[,2]/papersByYear_sc[,2] * 100)
tmp2 <- as.matrix(dif_author_counting_sc[,2]/papersByYear_sc[,2] * 100)
tmp <- cbind(tmp2,tmp)
rownames(tmp) <- as.character(1996:2014)
kable(tmp, digits = 1, caption = "Prozentualer Anteil von pk_items mit Unterschieden in author_cnt, bzw. inst_cnt und Zählung der zugehörigen fk_authors, bzw. fk_institutions (Scopus)", row.names = TRUE, col.names=c("fk_authors", "fk_institutions"))
```

Das Feld *inst_cnt* ist derzeit noch nicht in der scopus_b_16 gefüllt und verursacht daher die Differenz zur Zählung mittels *COUNT(DISTINCT fk_institutions)*.

# Zusammenfassung

Für die gebotene Fraktionierung auf Autorenebene ist eine gut gepflegte Zuschreibung zwischen Autor und Institution essentiell.

Im WoS reduziert sich das Ausmaß fehlender Zuordnung zwischen Autor und Institution erst in 2012 auf ein einstelliges Prozentniveau (normiert auf *pk_items*). Die Differenz zwischen einer Zählung der zu einem paper zugehörigen Autoren und der Angabe *author_cnt* erreicht sogar erst in 2014 einstellige Prozentwerte.

In Scopus liegt die Rate von *pk_items* mit ungenügender Zuordnung dagegen seit 2005 auf einstelligem Niveau und vorher auf sehr niedrigem zweistelligen Niveau.

Eine Nutzung der WoS für Fraktionierungszwecke erscheint daher nur für den aktuellen Rand angebracht, während Scopus Daten auch für die Vergangenheit ein ausreichendes Niveau aufweisen sollten.

```{r teardown, include=FALSE}
dbDisconnect(OraConn)
```


# Literatur
